import telebot
from telebot import types
import yt_dlp
import os
import time
from keep_alive import keep_alive

# ЁЯФ╣ ржЖржкржирж╛рж░ ржмржЯ ржЯрзЛржХрзЗржи ржПржЦрж╛ржирзЗ ржжрж┐ржи
API_TOKEN = '8239092365:AAHW3rOArfP_bvyoKFkoBGDpWdlrbJ-cBK0'
bot = telebot.TeleBot(API_TOKEN)

# ржЗржЙржЬрж╛рж░ржжрзЗрж░ ржбрзЗржЯрж╛ ржПржмржВ рж╕ржорзНржорждрж┐ рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ ржоржирзЗ рж░рж╛ржЦрж╛рж░ ржЬржирзНржп
user_data = {}
verified_users = set()

# ==========================================
# 1. рж╕рзНржмрж╛ржЧрждржо ржорзЗрж╕рзЗржЬ ржУ ржирзАрждрж┐ржорж╛рж▓рж╛ (Terms & Conditions)
# ==========================================
@bot.message_handler(commands=['start'])
def send_welcome(message):
    chat_id = message.chat.id
    user_name = message.from_user.first_name

    # ржЗржЙржЬрж╛рж░ ржпржжрж┐ ржЖржЧрзЗ рж╕ржорзНржорждрж┐ ржжрж┐рзЯрзЗ ржерж╛ржХрзЗ, рж╕рж░рж╛рж╕рж░рж┐ ржорзЗржЗржи ржорзЗржирзБ ржжрзЗржЦрж╛ржмрзЗ
    if chat_id in verified_users:
        show_main_menu(chat_id, user_name)
    else:
        # рж╕ржорзНржорждрж┐ ржмрж╛ржЯржи
        markup = types.InlineKeyboardMarkup()
        btn_agree = types.InlineKeyboardButton("тЬЕ ржЖржорж┐ рж╕ржорзНржоржд", callback_data="agree_terms")
        markup.add(btn_agree)

        rules_text = (
            f"ЁЯСЛ рж╕рзНржмрж╛ржЧрждржо! {user_name}\n\n"
            "ржПржЗ ржмржЯржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржЖржкржирж┐ рж╕рж╣ржЬрзЗржЗ TikTok ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржитАФржжрзНрж░рзБржд, рж╕рж╣ржЬ ржУ рж╕ржорзНржкрзВрж░рзНржг ржлрзНрж░рж┐ ЁЯУе\n\n"
            "ЁЯУЬ **ржмрзНржпржмрж╣рж╛рж░ ржирзАрждрж┐ржорж╛рж▓рж╛:**\n"
            "тАв ржмржЯржЯрж┐ рж╢рзБржзрзБржорж╛рждрзНрж░ ржмрзНржпржХрзНрждрж┐ржЧржд ржУ ржмрзИржз ржмрзНржпржмрж╣рж╛рж░рзЗрж░ ржЬржирзНржп\n"
            "тАв ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛ ржХржиржЯрзЗржирзНржЯрзЗрж░ ржХржкрж┐рж░рж╛ржЗржЯ ржжрж╛рзЯржнрж╛рж░ ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзАрж░\n"
            "тАв рж╕рзНржкрзНржпрж╛ржо ржмрж╛ ржЕржкржмрзНржпржмрж╣рж╛рж░ ржХрж░рж▓рзЗ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржмржирзНржз ржХрж░рж╛ рж╣рждрзЗ ржкрж╛рж░рзЗ\n"
            "тАв ржирж┐рзЯржо ржкрж░рж┐ржмрж░рзНрждржирзЗрж░ ржЕржзрж┐ржХрж╛рж░ ржбрзЗржнрзЗрж▓ржкрж╛рж░рзЗрж░ рж╕ржВрж░ржХрзНрж╖рж┐ржд\n\n"
            "ржмржЯ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржЖржкржирж┐ ржЙржкрж░рзЛржХрзНржд рж╢рж░рзНрждрзЗ рж╕ржорзНржоржд рж╣ржЪрзНржЫрзЗржи тЬЕ\n\n"
            "ЁЯЫа Developer: Ayman Hasan Shaan\n"
            "ЁЯП╖ Brand: Swygen IT"
        )
        bot.send_message(chat_id, rules_text, reply_markup=markup)

# рж╕ржорзНржорждрж┐ ржмрж╛ржЯржирзЗрж░ ржХрж╛ржЬ
@bot.callback_query_handler(func=lambda call: call.data == "agree_terms")
def handle_agreement(call):
    chat_id = call.message.chat.id
    user_name = call.from_user.first_name
    
    verified_users.add(chat_id) # ржЗржЙржЬрж╛рж░ржХрзЗ ржнрзЗрж░рж┐ржлрж╛ржЗржб рж▓рж┐рж╕рзНржЯрзЗ ржпрзЛржЧ ржХрж░рж╛ рж╣рж▓рзЛ
    bot.delete_message(chat_id, call.message.message_id) # рж░рзБрж▓рж╕ ржорзЗрж╕рзЗржЬ ржбрж┐рж▓рж┐ржЯ ржХрж░рзЗ ржХрзНрж▓рж┐ржи рж▓рзБржХ ржжрзЗржУрзЯрж╛
    
    bot.answer_callback_query(call.id, "ржзржирзНржпржмрж╛ржж! ржЖржкржирж┐ ржорзЗржЗржи ржорзЗржирзБрждрзЗ ржкрзНрж░ржмрзЗрж╢ ржХрж░рзЗржЫрзЗржиред")
    show_main_menu(chat_id, user_name)

# ==========================================
# 2. ржорзЗржЗржи ржорзЗржирзБ ржлрж╛ржВрж╢ржи (Reply Keyboard)
# ==========================================
def show_main_menu(chat_id, user_name):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    btn_download = types.KeyboardButton("тмЗя╕П ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб")
    btn_dev = types.KeyboardButton("ЁЯСитАНЁЯТ╗ ржбрзЗржнрзЗрж▓ржкрж╛рж░ ржЗржиржлрзЛ")
    btn_policy = types.KeyboardButton("ЁЯУЬ ржирзАрждрж┐ржорж╛рж▓рж╛")
    markup.add(btn_download, btn_dev, btn_policy)

    bot.send_message(chat_id, f"рж╕рзНржмрж╛ржЧрждржо {user_name}! ржирж┐ржЪрзЗрж░ ржорзЗржирзБ ржерзЗржХрзЗ ржЕржкрж╢ржи ржмрзЗржЫрзЗ ржирж┐ржи ЁЯСЗ", reply_markup=markup)

# ==========================================
# 3. ржбрзЗржнрзЗрж▓ржкрж╛рж░ ржЗржиржлрзЛ рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░
# ==========================================
@bot.message_handler(func=lambda message: message.text == "ЁЯСитАНЁЯТ╗ ржбрзЗржнрзЗрж▓ржкрж╛рж░ ржЗржиржлрзЛ")
def dev_info(message):
    markup = types.InlineKeyboardMarkup()
    btn_site = types.InlineKeyboardButton("ЁЯМР ржЕржлрж┐рж╕рж┐рзЯрж╛рж▓ ржУрзЯрзЗржмрж╕рж╛ржЗржЯ", url="https://swygen.xyz")
    markup.add(btn_site)

    info_text = (
        "ЁЯЫа **ржбрзЗржнрзЗрж▓ржкрж╛рж░ рждржерзНржп**\n\n"
        "ЁЯСитАНЁЯТ╗ ржбрзЗржнрзЗрж▓ржкрж╛рж░: Ayman Hasan Shaan\n"
        "ЁЯП╖ ржмрзНрж░рзНржпрж╛ржирзНржб: Swygen IT\n\n"
        "ЁЯЪА Swygen IT ржЖржзрзБржирж┐ржХ ржкрзНрж░ржпрзБржХрзНрждрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ рж╕рж╣ржЬ, ржжрзНрж░рзБржд ржУ ржирж┐рж░рзНржнрж░ржпрзЛржЧрзНржп ржбрж┐ржЬрж┐ржЯрж╛рж▓ рж╕рж▓рзНржпрзБрж╢ржи рждрзИрж░рж┐ ржХрж░рзЗред ржЖржорж╛ржжрзЗрж░ рж▓ржХрзНрж╖рзНржп рж╣рж▓рзЛ ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзАржжрзЗрж░ ржЬржирзНржп ржХрж╛рж░рзНржпржХрж░, ржирж┐рж░рж╛ржкржж ржУ ржмрзНржпржмрж╣рж╛рж░ржмрж╛ржирзНржзржм рж╕рж╛рж░рзНржнрж┐рж╕ ржкрзНрж░ржжрж╛ржи ржХрж░рж╛ред\n\n"
        "ЁЯМР ржЖржорж╛ржжрзЗрж░ рж╕ржХрж▓ рж╕рж╛рж░рзНржнрж┐рж╕, ржкрзНрж░ржЬрзЗржХрзНржЯ ржУ ржЖржкржбрзЗржЯ рж╕ржорзНржкрж░рзНржХрзЗ ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд ржЬрж╛ржирждрзЗ ржнрж┐ржЬрж┐ржЯ ржХрж░рзБржи ржЖржорж╛ржжрзЗрж░ ржЕржлрж┐рж╕рж┐рзЯрж╛рж▓ ржУрзЯрзЗржмрж╕рж╛ржЗржЯрзЗред\n\n"
        "ЁЯТб ржЖржкржирж╛рж░ ржорждрж╛ржоржд ржУ ржкрж░рж╛ржорж░рзНрж╢ ржЖржорж╛ржжрзЗрж░ ржЖрж░ржУ ржнрж╛рж▓рзЛ ржХрж░рждрзЗ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рзЗред\n\n"
        "ржзржирзНржпржмрж╛ржж ржЖржорж╛ржжрзЗрж░ рж╕рж╛ржерзЗ ржерж╛ржХрж╛рж░ ржЬржирзНржп тЭдя╕П"
    )
    bot.send_message(message.chat.id, info_text, reply_markup=markup)

# ==========================================
# 4. ржирзАрждрж┐ржорж╛рж▓рж╛ ржмрж╛ржЯржи рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░
# ==========================================
@bot.message_handler(func=lambda message: message.text == "ЁЯУЬ ржирзАрждрж┐ржорж╛рж▓рж╛")
def policy_info(message):
    policy_text = (
        "ЁЯСЛ **рж╕рзНржмрж╛ржЧрждржо!**\n"
        "ржЖржорж┐ ржЖржпрж╝ржорж╛ржи рж╣рж╛рж╕рж╛ржи рж╢рж╛ржи тАФ\n"
        "ржЖржорж┐ ржЖржкржирж╛ржжрзЗрж░ ржЬржирзНржп рж╕ржорзНржкрзВрж░рзНржг ржлрзНрж░рж┐ TikTok Video Downloader Telegram Bot рждрзИрж░рж┐ ржХрж░рзЗржЫрж┐ред\n\n"
        "ЁЯОп **ржПржЗ ржмржЯрзЗрж░ ржорж╛ржзрзНржпржорзЗ ржЖржкржирж┐ ржпрж╛ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржи:**\n"
        "тЬЕ TikTok ржнрж┐ржбрж┐ржУ ржУржпрж╝рж╛ржЯрж╛рж░ржорж╛рж░рзНржХ ржЫрж╛ржбрж╝рж╛ ржбрж╛ржЙржирж▓рзЛржб\n"
        "тЬЕ HD ржХрзЛржпрж╝рж╛рж▓рж┐ржЯрж┐рждрзЗ ржнрж┐ржбрж┐ржУ рж╕рзЗржн\n"
        "тЬЕ ржХрзЛржирзЛ рж▓ржЧржЗржи ржмрж╛ ржкрзЗржорзЗржирзНржЯ ржЫрж╛ржбрж╝рж╛ржЗ рззрзжрзж% ржлрзНрж░рж┐\n"
        "тЬЕ ржЦрзБржм рж╕рж╣ржЬ ржУ ржжрзНрж░рзБржд ржмрзНржпржмрж╣рж╛рж░ржпрзЛржЧрзНржп\n\n"
        "ЁЯУМ **ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛рж░ ржирж┐ржпрж╝ржо:**\n"
        "1я╕ПтГг TikTok ржнрж┐ржбрж┐ржУрж░ рж▓рж┐ржВржХ ржХржкрж┐ ржХрж░рзБржи\n"
        "2я╕ПтГг ржмржЯрзЗ ржкрж╛ржарж╛ржи\n"
        "3я╕ПтГг ржХржпрж╝рзЗржХ рж╕рзЗржХрзЗржирзНржб ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзБржи\n"
        "4я╕ПтГг ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рзБржи ЁЯУе\n\n"
        "ЁЯТб **ржирзЛржЯ:**\n"
        "ржПржЗ ржмржЯржЯрж┐ рж╢рзБржзрзБржорж╛рждрзНрж░ рж╢рж┐ржХрзНрж╖рж╛ржорзВрж▓ржХ ржУ ржмрзНржпржХрзНрждрж┐ржЧржд ржмрзНржпржмрж╣рж╛рж░рзЗрж░ ржЬржирзНржпред\n"
        "ржХрзЛржирзЛ ржнрж┐ржбрж┐ржУрж░ ржХржкрж┐рж░рж╛ржЗржЯ ржжрж╛ржпрж╝ржнрж╛рж░ ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзАрж░ ржирж┐ржЬрзЗрж░ред\n\n"
        "тЭдя╕П ржпржжрж┐ ржмржЯржЯрж┐ ржнрж╛рж▓рзЛ рж▓рж╛ржЧрзЗ, ржмржирзНржзрзБржжрзЗрж░ рж╕рж╛ржерзЗ рж╢рзЗржпрж╝рж╛рж░ ржХрж░рзБржиред\n"
        "ЁЯРЮ ржХрзЛржирзЛ рж╕ржорж╕рзНржпрж╛ ржмрж╛ ржлрж┐ржбржмрзНржпрж╛ржХ ржерж╛ржХрж▓рзЗ ржЬрж╛ржирж╛рждрзЗ ржнрзБрж▓ржмрзЗржи ржирж╛ред\n\n"
        "ржзржирзНржпржмрж╛ржж рж╕ржмрж╛ржЗржХрзЗ ЁЯЩП\n"
        "тАФ Developer: ржЖржпрж╝ржорж╛ржи рж╣рж╛рж╕рж╛ржи рж╢рж╛ржи"
    )
    bot.send_message(message.chat.id, policy_text)

# ==========================================
# 5. ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржкрзНрж░рж╕рзЗрж╕
# ==========================================
@bot.message_handler(func=lambda message: message.text == "тмЗя╕П ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб")
def ask_for_link(message):
    # ржЗржЙржЬрж╛рж░ ржнрзЗрж░рж┐ржлрж╛ржЗржб ржХрж┐ ржирж╛ ржЪрзЗржХ ржХрж░рж╛
    if message.chat.id not in verified_users:
        send_welcome(message)
        return
        
    msg = bot.send_message(message.chat.id, "ЁЯФЧ ржжрзЯрж╛ ржХрж░рзЗ ржЖржкржирж╛рж░ **TikTok ржнрж┐ржбрж┐ржУрж░ рж▓рж┐ржВржХржЯрж┐** ржжрж┐ржи:")
    bot.register_next_step_handler(msg, process_link)

def process_link(message):
    url = message.text
    chat_id = message.chat.id

    if "tiktok.com" not in url:
        bot.send_message(chat_id, "тЭМ ржПржЯрж┐ рж╕ржарж┐ржХ TikTok рж▓рж┐ржВржХ ржирзЯред ржжрзЯрж╛ ржХрж░рзЗ ржЖржмрж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржиред")
        return

    user_data[chat_id] = url

    # ржХрзЛрзЯрж╛рж▓рж┐ржЯрж┐ рж╕рж┐рж▓рзЗржХрж╢ржи ржмрж╛ржЯржи
    markup = types.InlineKeyboardMarkup(row_width=1)
    btn_nowm = types.InlineKeyboardButton("ЁЯЪл Without Watermark", callback_data="type_nowm")
    btn_hd = types.InlineKeyboardButton("ЁЯМЯ HD Quality (2K/4K)", callback_data="type_hd")
    btn_mp3 = types.InlineKeyboardButton("ЁЯО╡ MP3 (Audio Only)", callback_data="type_mp3")
    markup.add(btn_nowm, btn_hd, btn_mp3)

    bot.send_message(chat_id, "ЁЯУе ржЖржкржирж┐ ржХрзЛржи ржлрж░ржорзНржпрж╛ржЯрзЗ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рждрзЗ ржЪрж╛ржи?", reply_markup=markup)

# ==========================================
# 6. ржлрж░ржорзНржпрж╛ржЯ ржЕржирзБржпрж╛рзЯрзА ржбрж╛ржЙржирж▓рзЛржб (Callback)
# ==========================================
@bot.callback_query_handler(func=lambda call: call.data in ["type_nowm", "type_hd", "type_mp3"])
def handle_download(call):
    chat_id = call.message.chat.id
    
    if chat_id not in user_data:
        bot.send_message(chat_id, "тЪая╕П рж╕рзЗрж╢ржи ржПржХрзНрж╕ржкрж╛рзЯрж╛рж░ рж╣рзЯрзЗ ржЧрзЗржЫрзЗред ржжрзЯрж╛ ржХрж░рзЗ ржЖржмрж╛рж░ рж▓рж┐ржВржХ ржжрж┐ржиред")
        return

    url = user_data[chat_id]
    format_type = call.data
    
    bot.edit_message_text(chat_id=chat_id, message_id=call.message.message_id, text="тП│ ржбрж╛ржЙржирж▓рзЛржб рж╣ржЪрзНржЫрзЗ... ржжрзЯрж╛ ржХрж░рзЗ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзБржи (HD ржкрзНрж░рж╕рзЗрж╕рж┐ржВ)ред")

    try:
        file_name = f"swygen_vid_{chat_id}"
        ydl_opts = {}

        # рж╣рж╛ржЗ ржХрзЛрзЯрж╛рж▓рж┐ржЯрж┐ ржПржмржВ ржлрж░ржорзНржпрж╛ржЯ рж▓ржЬрж┐ржХ
        if format_type == "type_mp3":
            file_name += ".mp3"
            ydl_opts = {
                'format': 'bestaudio/best',
                'outtmpl': file_name,
            }
        elif format_type == "type_hd":
            file_name += ".mp4"
            # рж╕рж░рзНржмрзЛржЪрзНржЪ ржХрзЛрзЯрж╛рж▓рж┐ржЯрж┐ (2K/4K ржпржжрж┐ ржерж╛ржХрзЗ)
            ydl_opts = {
                'format': 'bestvideo+bestaudio/best', 
                'outtmpl': file_name,
                'merge_output_format': 'mp4',
            }
        else: # Without Watermark (рж╕рж╛ржзрж╛рж░ржгржд ржбрж┐ржлрж▓рзНржЯ ржмрзЗрж╕рзНржЯ)
            file_name += ".mp4"
            ydl_opts = {
                'format': 'best',
                'outtmpl': file_name,
            }

        # ржбрж╛ржЙржирж▓рзЛржб
        with yt_dlp.YoutubeDL(ydl_opts) as ydl:
            ydl.download([url])

        # ржлрж╛ржЗрж▓ ржкрж╛ржарж╛ржирзЛ
        with open(file_name, 'rb') as file:
            caption_text = "тЬЕ ржбрж╛ржЙржирж▓рзЛржб рж╕ржорзНржкржирзНржи!\nЁЯП╖ Brand: Swygen IT"
            if format_type == "type_mp3":
                bot.send_audio(chat_id, file, caption=caption_text)
            else:
                bot.send_video(chat_id, file, caption=caption_text)

        # ЁЯФ╣ ржЕржЯрзЛржорзЗржЯрж┐ржХ ржлрж┐ржбржмрзНржпрж╛ржХ ржорзЗрж╕рзЗржЬ
        markup = types.InlineKeyboardMarkup()
        btn_site = types.InlineKeyboardButton("ЁЯМР Visit Swygen.xyz", url="https://swygen.xyz")
        markup.add(btn_site)
        
        user_name = call.from_user.first_name
        feedback_msg = f"ржкрзНрж░рж┐рзЯ {user_name}, рж╕рж╛рж░рзНржнрж┐рж╕ржЯрж┐ ржХрзА рж░ржХржо рж▓рж╛ржЧрж▓рзЛ ржЬрж╛ржирж╛рждрзЗ ржнрзБрж▓ржмрзЗржи ржирж╛! тЭдя╕П\nржЖржкржирж╛рж░ ржорждрж╛ржоржд ржЖржорж╛ржжрзЗрж░ ржЬржирзНржп ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржгред"
        
        bot.send_message(chat_id, feedback_msg, reply_markup=markup)

        # ржХрзНрж▓рж┐ржиржЖржк
        if os.path.exists(file_name):
            os.remove(file_name)

    except Exception as e:
        bot.send_message(chat_id, "тЭМ ржжрзБржГржЦрж┐ржд, ржнрж┐ржбрж┐ржУржЯрж┐ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛ рж╕ржорзНржнржм рж╣рзЯржирж┐ред\nрж╕ржорзНржнрж╛ржмрзНржп ржХрж╛рж░ржг: рж▓рж┐ржВржХржЯрж┐ ржнрзБрж▓ ржЕржержмрж╛ ржнрж┐ржбрж┐ржУржЯрж┐ ржкрзНрж░рж╛ржЗржнрзЗржЯред")
        if os.path.exists(file_name):
            try: os.remove(file_name)
            except: pass

# Keep Alive & Run
keep_alive()
bot.polling(none_stop=True)
